<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Voice Assistant Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .dashboard {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            background: white;
            padding: 20px 30px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            color: #333;
            font-size: 28px;
        }

        .header .status-badge {
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 14px;
        }

        .status-badge.online {
            background: #10b981;
            color: white;
        }

        .status-badge.offline {
            background: #ef4444;
            color: white;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .tab {
            background: white;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 500;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .tab:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }

        .tab.active {
            background: #667eea;
            color: white;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .card {
            background: white;
            padding: 24px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .card h2 {
            color: #333;
            font-size: 20px;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .metric {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid #f0f0f0;
        }

        .metric:last-child {
            border-bottom: none;
        }

        .metric-label {
            color: #666;
            font-size: 14px;
        }

        .metric-value {
            font-size: 18px;
            font-weight: bold;
            color: #333;
        }

        .metric-value.success {
            color: #10b981;
        }

        .metric-value.error {
            color: #ef4444;
        }

        .metric-value.warning {
            color: #f59e0b;
        }

        button {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s;
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            background: #5568d3;
        }

        .btn-success {
            background: #10b981;
            color: white;
        }

        .btn-success:hover:not(:disabled) {
            background: #059669;
        }

        .btn-danger {
            background: #ef4444;
            color: white;
        }

        .btn-danger:hover:not(:disabled) {
            background: #dc2626;
        }

        .call-item {
            background: #f9fafb;
            padding: 16px;
            border-radius: 8px;
            margin-bottom: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .call-info {
            flex: 1;
        }

        .call-number {
            font-weight: bold;
            color: #333;
            font-size: 16px;
        }

        .call-details {
            font-size: 12px;
            color: #666;
            margin-top: 4px;
        }

        .log-viewer {
            background: #1e293b;
            color: #e2e8f0;
            padding: 16px;
            border-radius: 8px;
            height: 400px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 13px;
        }

        .log-entry {
            padding: 4px 0;
            border-bottom: 1px solid #334155;
        }

        .log-entry.info {
            color: #60a5fa;
        }

        .log-entry.success {
            color: #34d399;
        }

        .log-entry.error {
            color: #f87171;
        }

        .log-entry.warning {
            color: #fbbf24;
        }

        .input-group {
            display: flex;
            gap: 10px;
            margin-bottom: 16px;
        }

        .input-group input {
            flex: 1;
            padding: 10px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 14px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-top: 16px;
        }

        .stat-box {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
        }

        .stat-number {
            font-size: 32px;
            font-weight: bold;
            margin-bottom: 8px;
        }

        .stat-label {
            font-size: 14px;
            opacity: 0.9;
        }

        .voice-controls {
            display: flex;
            flex-direction: column;
            gap: 16px;
            align-items: center;
        }

        .record-btn {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            border: none;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .record-btn.recording {
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.05); opacity: 0.8; }
        }

        .volume-control {
            width: 100%;
            margin: 12px 0;
        }

        .volume-control label {
            display: block;
            margin-bottom: 8px;
            color: #666;
            font-size: 14px;
        }

        .volume-control input[type="range"] {
            width: 100%;
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: #9ca3af;
            font-style: italic;
        }

        .badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
            margin-left: 8px;
        }

        .badge.inbound {
            background: #dbeafe;
            color: #1e40af;
        }

        .badge.outbound {
            background: #fef3c7;
            color: #92400e;
        }

        .config-table {
            width: 100%;
            margin-top: 16px;
        }

        .config-table tr {
            border-bottom: 1px solid #f0f0f0;
        }

        .config-table td {
            padding: 12px 8px;
        }

        .config-table td:first-child {
            font-weight: 500;
            color: #666;
            width: 40%;
        }

        .config-table td:last-child {
            color: #333;
            font-family: 'Courier New', monospace;
            font-size: 13px;
        }
    </style>
</head>
<body>
    <div class="dashboard">
        <div class="header">
            <h1>Voice Assistant Dashboard</h1>
            <span id="systemStatus" class="status-badge offline">Offline</span>
        </div>

        <div class="tabs">
            <div class="tab active" onclick="switchTab('overview')">Overview</div>
            <div class="tab" onclick="switchTab('calls')">Active Calls</div>
            <div class="tab" onclick="switchTab('costs')">ðŸ’° Costs</div>
            <div class="tab" onclick="switchTab('voice')">Voice Test</div>
            <div class="tab" onclick="switchTab('stats')">Statistics</div>
            <div class="tab" onclick="switchTab('config')">Configuration</div>
            <div class="tab" onclick="switchTab('logs')">Logs</div>
        </div>

        <!-- Overview Tab -->
        <div id="overview" class="tab-content active">
            <div class="grid">
                <div class="card">
                    <h2>System Health</h2>
                    <div class="metric">
                        <span class="metric-label">API Server</span>
                        <span id="apiStatus" class="metric-value">Checking...</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">ARI Connection</span>
                        <span id="ariStatus" class="metric-value">Checking...</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">RTP Server</span>
                        <span id="rtpStatus" class="metric-value">Checking...</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">SIP Registration</span>
                        <span id="sipStatus" class="metric-value">Checking...</span>
                    </div>
                </div>

                <div class="card">
                    <h2>Real-time Metrics</h2>
                    <div class="metric">
                        <span class="metric-label">Active Calls</span>
                        <span id="activeCallsCount" class="metric-value">0</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">RTP Sessions</span>
                        <span id="rtpSessionsCount" class="metric-value">0</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Server Uptime</span>
                        <span id="serverUptime" class="metric-value">--</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Memory Usage</span>
                        <span id="memoryUsage" class="metric-value">--</span>
                    </div>
                </div>

                <div class="card">
                    <h2>Quick Actions</h2>
                    <div style="display: flex; flex-direction: column; gap: 12px;">
                        <button class="btn-primary" onclick="refreshData()">Refresh Status</button>
                        <button class="btn-success" onclick="switchTab('voice')">Test Voice Assistant</button>
                        <button class="btn-primary" onclick="switchTab('calls')">View Active Calls</button>
                        <button class="btn-danger" onclick="clearLogs()">Clear Logs</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Active Calls Tab -->
        <div id="calls" class="tab-content">
            <div class="card">
                <h2>Make Outbound Call</h2>
                <div class="input-group">
                    <input type="text" id="phoneNumber" placeholder="Enter phone number or extension (e.g., 1003)">
                    <button class="btn-success" onclick="makeCall()">Call</button>
                </div>
            </div>

            <div class="card">
                <h2>Active Calls <span id="callsCount" class="badge inbound">0</span></h2>
                <div id="activeCallsList"></div>
            </div>

            <div class="card">
                <h2>RTP Sessions</h2>
                <div id="rtpSessionsList"></div>
            </div>
        </div>

        <!-- Costs Tab -->
        <div id="costs" class="tab-content">
            <div class="card">
                <h2>Cost Monitoring & Analytics</h2>
                <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                    <button class="btn-primary" onclick="refreshCosts('all')">All Time</button>
                    <button class="btn-primary" onclick="refreshCosts('day')">Last 24h</button>
                    <button class="btn-primary" onclick="refreshCosts('week')">Last 7d</button>
                    <button class="btn-primary" onclick="refreshCosts('month')">Last 30d</button>
                </div>
                <div id="costPeriodLabel" style="font-weight: bold; color: #667eea; margin-bottom: 16px;">Showing: All Time</div>
            </div>

            <div class="grid">
                <div class="card">
                    <h2>ðŸ’µ Total Costs <span id="selectedPeriod"></span></h2>
                    <div class="metric">
                        <span class="metric-label">Total Calls</span>
                        <span id="costTotalCalls" class="metric-value">0</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Total Duration</span>
                        <span id="costTotalDuration" class="metric-value">0s</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Total Cost</span>
                        <span id="costTotalCost" class="metric-value success">Â£0.00</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Avg Cost/Call</span>
                        <span id="costAvgCost" class="metric-value">Â£0.00</span>
                    </div>
                </div>

                <div class="card">
                    <h2>ðŸ“Š Cost Breakdown</h2>
                    <div class="metric">
                        <span class="metric-label">Audio Input</span>
                        <span id="costAudioInput" class="metric-value">Â£0.00</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Audio Output</span>
                        <span id="costAudioOutput" class="metric-value">Â£0.00</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Function Calls</span>
                        <span id="costFunctionCalls" class="metric-value">Â£0.00</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Avg Duration</span>
                        <span id="costAvgDuration" class="metric-value">0s</span>
                    </div>
                </div>

                <div class="card">
                    <h2>ðŸ“ˆ Projections</h2>
                    <div class="metric">
                        <span class="metric-label">Daily Estimate</span>
                        <span id="projectionDaily" class="metric-value">Â£0.00</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Weekly Estimate</span>
                        <span id="projectionWeekly" class="metric-value">Â£0.00</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Monthly Estimate</span>
                        <span id="projectionMonthly" class="metric-value warning">Â£0.00</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Cost per Minute</span>
                        <span id="costPerMinute" class="metric-value">Â£0.00</span>
                    </div>
                </div>
            </div>

            <div class="card">
                <h2>Recent Calls with Costs</h2>
                <div id="recentCallsCosts"></div>
            </div>

            <div class="card">
                <h2>ðŸ’¡ Cost Optimization Tips</h2>
                <div style="padding: 16px; background: #f9fafb; border-radius: 8px;">
                    <ul style="margin-left: 20px; line-height: 1.8;">
                        <li><strong>Current Setup:</strong> Using GPT-4o Mini (most cost-effective)</li>
                        <li><strong>Shorter greetings</strong> reduce audio tokens</li>
                        <li><strong>Faster transfers</strong> to humans save AI costs</li>
                        <li><strong>Efficient responses</strong> minimize back-and-forth</li>
                        <li><strong>Voice Activity Detection</strong> already optimized</li>
                    </ul>
                </div>
            </div>

            <div class="card">
                <h2>API Pricing Reference</h2>
                <table class="config-table">
                    <tr>
                        <td>Audio Input</td>
                        <td>Â£0.47 / 1M tokens (~Â£0.0012/min)</td>
                    </tr>
                    <tr>
                        <td>Audio Output</td>
                        <td>Â£1.90 / 1M tokens (~Â£0.0047/min)</td>
                    </tr>
                    <tr>
                        <td>Text/Function Calls</td>
                        <td>Â£0.47 / 1M tokens</td>
                    </tr>
                    <tr>
                        <td>Model</td>
                        <td>GPT-4o Mini Realtime</td>
                    </tr>
                    <tr>
                        <td>Exchange Rate</td>
                        <td>USD to GBP: 0.79</td>
                    </tr>
                </table>
            </div>
        </div>

        <!-- Voice Test Tab -->
        <div id="voice" class="tab-content">
            <div class="grid">
                <div class="card">
                    <h2>Voice Assistant Test</h2>
                    <div style="text-align: center;">
                        <div id="voiceStatus" style="padding: 16px; background: #f9fafb; border-radius: 8px; margin-bottom: 20px; font-weight: 500; color: #666;">
                            Disconnected
                        </div>

                        <div class="voice-controls">
                            <button id="connectBtn" class="btn-success" onclick="voiceConnect()">Connect</button>
                            <button id="disconnectBtn" class="btn-danger" onclick="voiceDisconnect()" disabled>Disconnect</button>
                            <button id="recordBtn" class="record-btn btn-primary" disabled>
                                Hold to Talk
                            </button>
                        </div>

                        <div class="volume-control">
                            <label for="inputVolume">Input Volume: <span id="inputVolumeValue">50%</span></label>
                            <input type="range" id="inputVolume" min="0" max="100" value="50" oninput="updateVolume('input', this.value)">
                        </div>

                        <div class="volume-control">
                            <label for="outputVolume">Output Volume: <span id="outputVolumeValue">75%</span></label>
                            <input type="range" id="outputVolume" min="0" max="100" value="75" oninput="updateVolume('output', this.value)">
                        </div>
                    </div>
                </div>

                <div class="card">
                    <h2>Voice Assistant Logs</h2>
                    <div class="log-viewer" id="voiceLogs" style="height: 500px;">
                        <div class="log-entry info">Ready to connect...</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Statistics Tab -->
        <div id="stats" class="tab-content">
            <div class="card">
                <h2>System Statistics</h2>
                <div class="stats-grid">
                    <div class="stat-box">
                        <div class="stat-number" id="totalCallsStat">0</div>
                        <div class="stat-label">Total Calls (Session)</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-number" id="avgDurationStat">0s</div>
                        <div class="stat-label">Avg Call Duration</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-number" id="rtpPacketsStat">0</div>
                        <div class="stat-label">RTP Packets</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-number" id="uptimeStat">0h</div>
                        <div class="stat-label">Uptime</div>
                    </div>
                </div>

                <div style="margin-top: 30px;">
                    <h3 style="margin-bottom: 16px;">Diagnostics</h3>
                    <pre id="diagnosticsData" style="background: #f9fafb; padding: 16px; border-radius: 8px; overflow-x: auto; font-size: 12px;">Loading...</pre>
                </div>
            </div>
        </div>

        <!-- Configuration Tab -->
        <div id="config" class="tab-content">
            <div class="card">
                <h2>System Configuration</h2>
                <table class="config-table" id="configTable">
                    <tr>
                        <td>Loading configuration...</td>
                        <td></td>
                    </tr>
                </table>
            </div>
        </div>

        <!-- Logs Tab -->
        <div id="logs" class="tab-content">
            <div class="card">
                <h2>Application Logs</h2>
                <div class="log-viewer" id="appLogs">
                    <div class="log-entry info">Waiting for logs...</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Dashboard JavaScript - all functionality inline
        let voiceWs = null;
        let audioContext = null;
        let playbackContext = null;
        let isRecording = false;
        let refreshInterval = null;
        let nextPlayTime = 0;
        const logs = [];

        // Initialize dashboard
        window.onload = function() {
            log('Dashboard initialized', 'info');
            refreshData();
            startAutoRefresh();
            setupRecordButton();
        };

        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            event.target.classList.add('active');
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            document.getElementById(tabName).classList.add('active');

            if (tabName === 'calls') refreshCalls();
            else if (tabName === 'stats') refreshStats();
            else if (tabName === 'config') refreshConfig();
            else if (tabName === 'costs') refreshCosts('all');
        }

        function startAutoRefresh() {
            refreshInterval = setInterval(refreshData, 5000);
        }

        async function refreshData() {
            try {
                const statusRes = await fetch('/status');
                const status = await statusRes.json();
                const systemStatus = document.getElementById('systemStatus');

                if (statusRes.ok) {
                    systemStatus.textContent = 'Online';
                    systemStatus.className = 'status-badge online';
                } else {
                    systemStatus.textContent = 'Offline';
                    systemStatus.className = 'status-badge offline';
                }

                updateMetric('ariStatus', status.ari_connected, 'Connected', 'Disconnected');
                updateMetric('rtpStatus', status.rtp_server, 'Running', 'Stopped');
                updateMetric('sipStatus', status.sip_registered, 'Registered', 'Not Registered');
                document.getElementById('apiStatus').textContent = 'Online';
                document.getElementById('apiStatus').className = 'metric-value success';
                document.getElementById('activeCallsCount').textContent = status.active_calls || 0;
                document.getElementById('rtpSessionsCount').textContent = status.rtp_sessions || 0;

                const diagRes = await fetch('/diagnostics');
                if (diagRes.ok) {
                    const diag = await diagRes.json();
                    document.getElementById('serverUptime').textContent = formatUptime(diag.uptime);
                    const memoryMB = (diag.memory.heapUsed / 1024 / 1024).toFixed(1);
                    document.getElementById('memoryUsage').textContent = memoryMB + ' MB';
                }
            } catch (error) {
                console.error('Error refreshing data:', error);
                document.getElementById('systemStatus').textContent = 'Error';
                document.getElementById('systemStatus').className = 'status-badge offline';
            }
        }

        async function refreshCalls() {
            try {
                const res = await fetch('/ari/calls');
                const data = await res.json();
                const callsList = document.getElementById('activeCallsList');
                const callsCount = document.getElementById('callsCount');

                if (!data.activeCalls || data.activeCalls.length === 0) {
                    callsList.innerHTML = '<div class="empty-state">No active calls</div>';
                    callsCount.textContent = '0';
                } else {
                    callsCount.textContent = data.activeCalls.length;
                    callsList.innerHTML = data.activeCalls.map(call =>
                        '<div class="call-item"><div class="call-info"><div class="call-number">' +
                        (call.direction === 'outbound' ? 'ðŸ“¤' : 'ðŸ“¥') + ' ' +
                        (call.callerNumber || 'Unknown') +
                        '<span class="badge ' + (call.direction || 'inbound') + '">' + (call.direction || 'inbound') + '</span>' +
                        '</div><div class="call-details">Duration: ' + call.duration + 's â€¢ ' + (call.callerName || 'No name') +
                        '</div></div><button class="btn-danger" onclick="hangupCall(\'' + call.callId + '\')">Hangup</button></div>'
                    ).join('');
                }

                const rtpRes = await fetch('/ari/rtp-sessions');
                const rtpData = await rtpRes.json();
                const rtpList = document.getElementById('rtpSessionsList');

                if (!rtpData.sessions || rtpData.sessions.length === 0) {
                    rtpList.innerHTML = '<div class="empty-state">No RTP sessions</div>';
                } else {
                    rtpList.innerHTML = rtpData.sessions.map(session =>
                        '<div class="call-item"><div class="call-info"><div class="call-number">RTP Session: ' + session.callId +
                        '</div><div class="call-details">' + (session.remoteAddress || 'Learning remote...') + ':' +
                        (session.remotePort || '?') + ' â€¢ Sent: ' + session.packetsSent + ' packets â€¢ Received: ' +
                        session.packetsReceived + ' packets</div></div></div>'
                    ).join('');
                }
            } catch (error) {
                console.error('Error fetching calls:', error);
            }
        }

        async function refreshStats() {
            try {
                const diagRes = await fetch('/diagnostics');
                const diag = await diagRes.json();
                document.getElementById('uptimeStat').textContent = formatUptime(diag.uptime);
                document.getElementById('diagnosticsData').textContent = JSON.stringify(diag, null, 2);
            } catch (error) {
                console.error('Error fetching stats:', error);
            }
        }

        async function refreshConfig() {
            try {
                const diagRes = await fetch('/diagnostics');
                const diag = await diagRes.json();
                const config = diag.config;
                const configTable = document.getElementById('configTable');
                configTable.innerHTML = Object.entries(config).map(([key, value]) =>
                    '<tr><td>' + key.replace(/_/g, ' ').toUpperCase() + '</td><td>' +
                    (value !== undefined && value !== null ? value : 'Not configured') + '</td></tr>'
                ).join('');
            } catch (error) {
                console.error('Error fetching config:', error);
            }
        }

        async function makeCall() {
            const phoneNumber = document.getElementById('phoneNumber').value.trim();
            if (!phoneNumber) {
                alert('Please enter a phone number');
                return;
            }

            try {
                log('Initiating call to ' + phoneNumber + '...', 'info');
                const res = await fetch('/ari/originate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ destination: phoneNumber, callerId: '1000' })
                });

                const result = await res.json();
                if (res.ok && result.success) {
                    log('Call initiated successfully to ' + phoneNumber, 'success');
                    document.getElementById('phoneNumber').value = '';
                    setTimeout(refreshCalls, 1000);
                } else {
                    log('Failed to make call: ' + (result.message || result.error), 'error');
                    alert('Failed to make call: ' + (result.message || result.error));
                }
            } catch (error) {
                log('Error making call: ' + error.message, 'error');
                alert('Error making call: ' + error.message);
            }
        }

        async function hangupCall(callId) {
            if (!confirm('Are you sure you want to hangup this call?')) return;

            try {
                log('Hanging up call ' + callId + '...', 'info');
                const res = await fetch('/ari/calls/' + callId, { method: 'DELETE' });
                const result = await res.json();

                if (res.ok) {
                    log('Call hung up successfully', 'success');
                    refreshCalls();
                } else {
                    log('Failed to hangup call: ' + result.message, 'error');
                }
            } catch (error) {
                log('Error hanging up call: ' + error.message, 'error');
            }
        }

        function voiceConnect() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = protocol + '//' + window.location.host + '/ws';

            logVoice('Connecting to ' + wsUrl + '...', 'info');
            voiceWs = new WebSocket(wsUrl);

            voiceWs.onopen = function() {
                logVoice('Connected to voice assistant', 'success');
                updateVoiceStatus('Connected - Ready to talk', true);
                voiceWs.send(JSON.stringify({ type: 'start_call' }));
            };

            voiceWs.onmessage = function(event) {
                const data = JSON.parse(event.data);
                if (data.type === 'session_ready') {
                    logVoice('OpenAI session ready', 'success');
                } else if (data.type === 'response.audio.delta' && data.delta) {
                    playAudio(data.delta);
                }
            };

            voiceWs.onclose = function() {
                logVoice('Disconnected from server', 'error');
                updateVoiceStatus('Disconnected', false);
            };

            voiceWs.onerror = function(error) {
                logVoice('WebSocket error', 'error');
            };
        }

        function voiceDisconnect() {
            if (voiceWs) {
                voiceWs.close();
                voiceWs = null;
            }
            if (playbackContext) {
                playbackContext.close();
                playbackContext = null;
            }
            updateVoiceStatus('Disconnected', false);
            logVoice('Disconnected from server', 'info');
        }

        function updateVoiceStatus(status, isConnected) {
            const statusEl = document.getElementById('voiceStatus');
            statusEl.textContent = status;
            statusEl.style.background = isConnected ? '#d1fae5' : '#fee2e2';
            statusEl.style.color = isConnected ? '#065f46' : '#991b1b';
            document.getElementById('connectBtn').disabled = isConnected;
            document.getElementById('disconnectBtn').disabled = !isConnected;
            document.getElementById('recordBtn').disabled = !isConnected;
        }

        async function startRecording() {
            if (!voiceWs || isRecording) return;

            try {
                const stream = await navigator.mediaDevices.getUserMedia({
                    audio: { channelCount: 1, sampleRate: 24000, echoCancellation: true, noiseSuppression: true }
                });

                audioContext = new AudioContext({ sampleRate: 24000 });
                const source = audioContext.createMediaStreamSource(stream);
                const processor = audioContext.createScriptProcessor(4096, 1, 1);

                processor.onaudioprocess = function(event) {
                    if (isRecording && voiceWs && voiceWs.readyState === WebSocket.OPEN) {
                        const inputBuffer = event.inputBuffer;
                        const channelData = inputBuffer.getChannelData(0);
                        const pcmData = new Int16Array(channelData.length);
                        const inputVolume = document.getElementById('inputVolume').value / 100;

                        for (let i = 0; i < channelData.length; i++) {
                            const sample = channelData[i] * inputVolume;
                            pcmData[i] = Math.max(-1, Math.min(1, sample)) * 0x7FFF;
                        }

                        const base64Audio = btoa(String.fromCharCode(...new Uint8Array(pcmData.buffer)));
                        voiceWs.send(JSON.stringify({ type: 'audio_data', audio: base64Audio }));
                    }
                };

                source.connect(processor);
                processor.connect(audioContext.destination);

                isRecording = true;
                document.getElementById('recordBtn').textContent = 'Recording...';
                document.getElementById('recordBtn').classList.add('recording');
                logVoice('Started recording', 'info');

            } catch (error) {
                logVoice('Failed to start recording: ' + error.message, 'error');
            }
        }

        function stopRecording() {
            if (!isRecording) return;

            isRecording = false;
            document.getElementById('recordBtn').textContent = 'Hold to Talk';
            document.getElementById('recordBtn').classList.remove('recording');
            logVoice('Stopped recording', 'info');

            if (voiceWs && voiceWs.readyState === WebSocket.OPEN) {
                voiceWs.send(JSON.stringify({ type: 'commit_audio' }));
            }

            if (audioContext) {
                audioContext.close();
                audioContext = null;
            }
        }

        function playAudio(base64Audio) {
            try {
                if (!playbackContext) {
                    playbackContext = new AudioContext({ sampleRate: 24000 });
                    nextPlayTime = 0;
                }

                const binaryString = atob(base64Audio);
                const bytes = new Uint8Array(binaryString.length);
                for (let i = 0; i < binaryString.length; i++) {
                    bytes[i] = binaryString.charCodeAt(i);
                }

                const int16Array = new Int16Array(bytes.buffer);
                const float32Array = new Float32Array(int16Array.length);
                const outputVolume = document.getElementById('outputVolume').value / 100;

                for (let i = 0; i < int16Array.length; i++) {
                    float32Array[i] = (int16Array[i] / 32768.0) * outputVolume;
                }

                const audioBuffer = playbackContext.createBuffer(1, float32Array.length, playbackContext.sampleRate);
                audioBuffer.copyToChannel(float32Array, 0);

                const source = playbackContext.createBufferSource();
                source.buffer = audioBuffer;
                source.connect(playbackContext.destination);

                const currentTime = playbackContext.currentTime;
                const startTime = Math.max(currentTime, nextPlayTime);
                source.start(startTime);
                nextPlayTime = startTime + audioBuffer.duration;

            } catch (error) {
                console.error('Error playing audio:', error);
            }
        }

        function setupRecordButton() {
            const recordBtn = document.getElementById('recordBtn');
            recordBtn.addEventListener('mousedown', startRecording);
            recordBtn.addEventListener('mouseup', stopRecording);
            recordBtn.addEventListener('mouseleave', stopRecording);
            recordBtn.addEventListener('touchstart', function(e) { e.preventDefault(); startRecording(); });
            recordBtn.addEventListener('touchend', function(e) { e.preventDefault(); stopRecording(); });

            document.addEventListener('keydown', function(e) {
                if (e.code === 'Space' && !isRecording && !document.getElementById('recordBtn').disabled) {
                    e.preventDefault();
                    startRecording();
                }
            });
            document.addEventListener('keyup', function(e) {
                if (e.code === 'Space' && isRecording) {
                    e.preventDefault();
                    stopRecording();
                }
            });
        }

        function updateVolume(type, value) {
            document.getElementById(type + 'VolumeValue').textContent = value + '%';
        }

        function updateMetric(id, condition, trueText, falseText) {
            const el = document.getElementById(id);
            el.textContent = condition ? trueText : falseText;
            el.className = 'metric-value ' + (condition ? 'success' : 'error');
        }

        function formatUptime(seconds) {
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            return hours + 'h ' + minutes + 'm';
        }

        function log(message, type) {
            const timestamp = new Date().toLocaleTimeString();
            const entry = '[' + timestamp + '] ' + message;
            logs.push({ message: entry, type: type || 'info' });

            const logEl = document.getElementById('appLogs');
            if (logEl) {
                const logEntry = document.createElement('div');
                logEntry.className = 'log-entry ' + (type || 'info');
                logEntry.textContent = entry;
                logEl.appendChild(logEntry);
                logEl.scrollTop = logEl.scrollHeight;
            }
        }

        function logVoice(message, type) {
            const timestamp = new Date().toLocaleTimeString();
            const entry = '[' + timestamp + '] ' + message;

            const logEl = document.getElementById('voiceLogs');
            if (logEl) {
                const logEntry = document.createElement('div');
                logEntry.className = 'log-entry ' + (type || 'info');
                logEntry.textContent = entry;
                logEl.appendChild(logEntry);
                logEl.scrollTop = logEl.scrollHeight;
            }
        }

        function clearLogs() {
            const appLogs = document.getElementById('appLogs');
            const voiceLogs = document.getElementById('voiceLogs');

            if (appLogs) appLogs.innerHTML = '<div class="log-entry info">Logs cleared</div>';
            if (voiceLogs) voiceLogs.innerHTML = '<div class="log-entry info">Logs cleared</div>';
            logs.length = 0;
        }

        async function refreshCosts(period) {
            try {
                const res = await fetch('/api/costs?period=' + period);
                const data = await res.json();

                // Update period label
                const periodLabels = {
                    'all': 'All Time',
                    'day': 'Last 24 Hours',
                    'week': 'Last 7 Days',
                    'month': 'Last 30 Days'
                };
                document.getElementById('costPeriodLabel').textContent = 'Showing: ' + periodLabels[period];

                // Get currency symbol from API
                const currency = data.pricing?.currencySymbol || 'Â£';

                // Update totals
                document.getElementById('costTotalCalls').textContent = data.stats.totalCalls;
                document.getElementById('costTotalDuration').textContent = Math.round(data.stats.totalDuration) + 's';
                document.getElementById('costTotalCost').textContent = currency + data.stats.totalCost.toFixed(4);
                document.getElementById('costAvgCost').textContent = currency + data.stats.avgCost.toFixed(4);
                document.getElementById('costAvgDuration').textContent = Math.round(data.stats.avgDuration) + 's';

                // Calculate breakdown
                const totalInputCost = data.recentCalls.reduce((sum, call) => sum + (call.audioInputCost || 0), 0);
                const totalOutputCost = data.recentCalls.reduce((sum, call) => sum + (call.audioOutputCost || 0), 0);
                const totalTextCost = data.recentCalls.reduce((sum, call) => sum + (call.textCost || 0), 0);

                document.getElementById('costAudioInput').textContent = currency + totalInputCost.toFixed(4);
                document.getElementById('costAudioOutput').textContent = currency + totalOutputCost.toFixed(4);
                document.getElementById('costFunctionCalls').textContent = currency + totalTextCost.toFixed(4);

                // Calculate cost per minute
                const totalMinutes = data.stats.totalDuration / 60;
                const costPerMin = totalMinutes > 0 ? data.stats.totalCost / totalMinutes : 0;
                document.getElementById('costPerMinute').textContent = currency + costPerMin.toFixed(4);

                // Projections based on current data
                const avgCostPerCall = data.stats.avgCost || 0;
                const avgCallsPerDay = period === 'day' ? data.stats.totalCalls :
                                      period === 'week' ? data.stats.totalCalls / 7 :
                                      period === 'month' ? data.stats.totalCalls / 30 : 0;

                if (avgCallsPerDay > 0) {
                    document.getElementById('projectionDaily').textContent = currency + (avgCallsPerDay * avgCostPerCall).toFixed(2);
                    document.getElementById('projectionWeekly').textContent = currency + (avgCallsPerDay * avgCostPerCall * 7).toFixed(2);
                    document.getElementById('projectionMonthly').textContent = currency + (avgCallsPerDay * avgCostPerCall * 30).toFixed(2);
                } else {
                    document.getElementById('projectionDaily').textContent = 'Need more data';
                    document.getElementById('projectionWeekly').textContent = 'Need more data';
                    document.getElementById('projectionMonthly').textContent = 'Need more data';
                }

                // Display recent calls
                const callsList = document.getElementById('recentCallsCosts');
                if (!data.recentCalls || data.recentCalls.length === 0) {
                    callsList.innerHTML = '<div class="empty-state">No calls yet</div>';
                } else {
                    callsList.innerHTML = data.recentCalls.map(call => {
                        const time = new Date(call.timestamp).toLocaleTimeString();
                        const date = new Date(call.timestamp).toLocaleDateString();
                        return '<div class="call-item">' +
                            '<div class="call-info">' +
                            '<div class="call-number">ðŸ“ž ' + (call.callerNumber || 'Unknown') + '</div>' +
                            '<div class="call-details">' + date + ' ' + time + ' â€¢ ' + call.duration + 's â€¢ ' +
                            '<span style="font-weight: bold; color: #10b981;">' + currency + call.totalCost.toFixed(4) + '</span>' +
                            '</div></div>' +
                            '</div>';
                    }).join('');
                }

            } catch (error) {
                console.error('Error fetching costs:', error);
                log('Error fetching cost data: ' + error.message, 'error');
            }
        }
    </script>
</body>
</html>
